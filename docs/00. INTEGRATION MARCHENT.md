# Dokumentasi Teknis Integrasi Merchant (GoFood/GoBiz)
**Sistem POS Setara Space**

Dokumen ini menjelaskan arsitektur, konfigurasi credential, alur data, dan panduan teknis implementasi modul integrasi merchant (Food Delivery Platform) pada sistem POS Setara Space.

---

## 1. Credentials & Konfigurasi

**PENTING:** Informasi di bawah ini bersifat **SANGAT RAHASIA**. Jangan membagikan file ini ke pihak yang tidak berkepentingan.

### A. GoFood / GoBiz API (Production)
Digunakan untuk integrasi real-time menerima pesanan dan sinkronisasi menu.

| Key | Value | Keterangan |
| :--- | :--- | :--- |
| **Partner ID** | `0621f165-13d3-43d2-9ef0-58554585977d` | ID Unik Merchant di sistem Gojek (Outlet ID) |
| **App ID / Client ID** | `iPlVMd0PAq3Z8pie` | Username untuk Auth API |
| **Client Secret** | `kSHJHHl7xt9TWkCnxFloOsyLDsrQnQpq` | Password untuk Auth API |
| **Relay Secret** | `1ef4a3c03e60272db47f55f1b313a4c80280eaeb8b9b4ea05c947ad00a046348.` | Kunci Validasi Webhook (Wajib ada titik di akhir jika asli demikian) |

### B. Endpoint Konfigurasi
URL Webhook yang harus didaftarkan di Dashboard GoBiz Developer:
- **Webhook URL:** `https://[DOMAIN_POS_ANDA]/api/webhooks/gofood`
- **Method:** `POST`

---

## 2. Arsitektur Sistem

Sistem ini menggunakan pendekatan **Centralized Gateway** dengan pola **Adapter Pattern** untuk memungkinkan skalabilitas ke platform lain (GrabFood, ShopeeFood) di masa depan tanpa mengubah kode inti POS.

### Struktur Modul
```
app/
├── Services/
│   └── Integration/
│       ├── Contracts/
│       │   └── FoodDeliveryProviderInterface.php  <-- Kontrak utama (Semua provider wajib ikut aturan ini)
│       ├── Providers/
│       │   ├── GoFoodProvider.php                 <-- Implementasi logika GoFood (Auth, Parse Order, Status Update)
│       │   ├── GrabFoodProvider.php               <-- (Future)
│       │   └── ShopeeFoodProvider.php             <-- (Future)
│       └── IntegrationManager.php                 <-- Factory untuk memilih driver yang tepat
├── Http/Controllers/Api/
│   └── WebhookController.php                      <-- Pintu masuk pesanan (Inbound)
├── Jobs/
│   ├── ProcessIntegrationOrder.php                <-- (Optional) Queue processing
│   ├── UpdateMerchantOrderStatus.php              <-- Background Job update status ke Gojek
│   └── SyncProductToAggregators.php               <-- Background Job update harga menu
└── Models/
    ├── Merchant.php                               <-- Master data (GoFood, Grab)
    ├── MerchantIntegration.php                    <-- Config per outlet (Enabled/Disabled)
    ├── MerchantCredential.php                     <-- Penyimpanan Secret (Encrypted)
    └── IntegrationLog.php                         <-- Log aktivitas API (Debug)
```

---

## 3. Alur Kerja (Data Flow)

### A. Inbound: Pesanan Masuk (GoFood -> POS)
1.  **Trigger:** Pelanggan pesan di aplikasi GoFood.
2.  **Webhook:** Server Gojek mengirim HTTP POST ke `/api/webhooks/gofood`.
3.  **Security Check:** `WebhookController` memvalidasi header `X-Go-Signature` menggunakan `Relay Secret` (HMAC-SHA256).
4.  **Parsing:** `GoFoodProvider` menerjemahkan JSON payload Gojek menjadi `StandardOrderDTO` (Format internal POS).
5.  **Idempotency:** Cek apakah Order ID Eksternal sudah ada di DB `merchant_orders`. Jika ya, skip.
6.  **Persist:** Simpan ke tabel `orders` (Status: Pending) dan `merchant_orders` (Linker).
7.  **Event:** Trigger `OrderReceived` (Notifikasi bunyi di Kasir/Dapur).

### B. Outbound: Update Status (POS -> GoFood)
1.  **Trigger:** Staff dapur mengubah status order jadi "Processing" atau "Completed".
2.  **Observer:** `OrderObserver` mendeteksi perubahan status.
3.  **Action Map:**
    - `processing` -> Kirim signal **ACCEPT/CONFIRM**
    - `completed` -> Kirim signal **READY FOR PICKUP**
    - `cancelled` -> Kirim signal **REJECT**
4.  **Job:** Dispatch `UpdateMerchantOrderStatus` (Queue Async).
5.  **API Call:** Job memanggil API GoBiz (PUT `/v1/orders/...`) menggunakan Access Token.
6.  **Retry:** Jika gagal (misal koneksi putus), job akan mengulang otomatis 3x.

### C. Sync: Update Menu (POS -> GoFood)
1.  **Trigger:** Manager mengubah Harga atau Status Aktif produk di POS.
2.  **Observer:** `ProductObserver` mendeteksi perubahan.
3.  **Job:** Dispatch `SyncProductToAggregators`.
4.  **Logic:** Loop semua Merchant Integrasi yang aktif -> Update harga produk berdasarkan SKU di semua platform.

---

## 4. Keamanan (Security Measures)

1.  **Credential Storage:**
    - Semua `Client Secret`, `Relay Secret`, dan `Access Token` disimpan di database menggunakan kolom `TEXT` tetapi isinya **TERENKRIPSI** (Laravel `encrypted` cast).
    - Hanya `Client ID` yang readable.

2.  **Webhook Validation:**
    - Wajib memvalidasi Signature Header untuk mencegah *Spoofing Attack* (Hacker mengirim order palsu).
    - Endpoint Webhook di-exclude dari CSRF Token protection (`bootstrap/app.php`).

3.  **Logging & Audit Trail:**
    - Tabel `integration_logs` mencatat semua request masuk (Inbound) dan keluar (Outbound).
    - Mencatat: Endpoint, Payload (Raw), Status Code, dan Error Message.

---

## 5. Panduan Operasional

### Cara Mengaktifkan Integrasi
1.  Login ke Control Panel sebagai Admin.
2.  Buka menu **Integrations**.
3.  Klik **Configure** pada kartu **GoFood**.
4.  Masukkan Credential (lihat Bagian 1 dokumen ini):
    - **Outlet ID**: Masukkan Partner ID.
    - **Client ID**: Masukkan App ID.
    - **Client Secret**: Masukkan Client Secret.
    - **Relay Secret**: Masukkan Relay Secret.
5.  Centang **Enable Integration**.
6.  Klik **Save & Connect**.
7.  Sistem akan otomatis melakukan Test Auth. Jika sukses, indikator berubah menjadi Hijau (Active).

### Troubleshooting Umum
- **Order tidak masuk?**
  - Cek `integration_logs`. Apakah ada log Inbound?
  - Jika tidak ada log sama sekali -> Masalah di sisi Webhook GoBiz (URL salah / Server down).
  - Jika ada log tapi error `401 Signature Invalid` -> Cek kembali `Relay Secret` apakah ada spasi/typo.
- **Status tidak update di Gojek?**
  - Cek `integration_logs` tipe Outbound.
  - Jika status 500/Timeout -> Kemungkinan masalah koneksi hosting ke luar. Job akan retry otomatis.
- **Menu Sync Gagal?**
  - Pastikan **SKU** produk di POS sama persis dengan **Item External ID** di GoBiz.

---
*Dokumen ini diperbarui terakhir pada: 29 Januari 2026*